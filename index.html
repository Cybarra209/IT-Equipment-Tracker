<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IT Asset Inventory Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; }
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-md">
    <div class="flex flex-col items-center mb-4">
      <img src="logo.png" alt="Logo" class="w-24 h-24 object-contain mb-2">
      <h1 class="text-2xl font-bold text-center">IT Asset Inventory Tracker</h1>
    </div>

    <div class="flex flex-wrap gap-2 mb-4">
      <button onclick="toggleHistory()" class="bg-yellow-500 text-white p-2 rounded hover:bg-yellow-600">Toggle Action History</button>
      <button onclick="window.print()" class="bg-gray-700 text-white p-2 rounded hover:bg-gray-800">Print Assets</button>
      <button onclick="printModalHistory()" class="bg-gray-600 text-white p-2 rounded hover:bg-gray-700">Print History</button>
    </div>

    <div class="flex flex-col md:flex-row gap-2 mb-4">
      <input type="text" id="search" placeholder="Search..." class="w-full md:w-1/3 p-2 border rounded" oninput="renderTable(this.value)">
      <button onclick="downloadAssets()" class="bg-green-500 text-white p-2 rounded hover:bg-green-600">Download CSV</button>
      <label class="bg-purple-500 text-white p-2 rounded hover:bg-purple-600 cursor-pointer text-center">
        Import CSV
        <input type="file" id="importFile" accept=".csv" class="hidden" onchange="importCSV(event)">
      </label>
    </div>

    <form id="assetForm" class="mb-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div><label>Employee Name</label>
          <input type="text" id="employeeName" class="w-full p-2 border rounded" required>
        </div>
        <div><label>Location</label>
          <select id="location" class="w-full p-2 border rounded">
            <option>Modesto</option><option>Ceres</option><option>Winton</option>
            <option>Madera</option><option>Patterson</option>
          </select>
        </div>
        <div><label>Item Type</label>
          <select id="itemType" class="w-full p-2 border rounded">
            <option>Laptop</option><option>Monitor</option><option>Desktop</option>
            <option>Docking Station</option><option>Printer</option><option>Miscellaneous</option>
          </select>
        </div>
        <div><label>Asset #</label>
          <input type="text" id="assetNumber" class="w-full p-2 border rounded" required>
        </div>
        <div><label>Serial #</label>
          <input type="text" id="serialNumber" class="w-full p-2 border rounded" required>
        </div>
        <div><label>Item Name</label>
          <input type="text" id="itemName" class="w-full p-2 border rounded" required>
        </div>
      </div>
      <input type="hidden" id="editIndex" value="-1">
      <button type="submit" id="submitButton" class="mt-4 w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Add Asset</button>
    </form>

    <div id="printArea">
      <div id="assetTableContainer" class="overflow-x-auto mb-6"></div>
    </div>

    <div id="historySection" class="bg-gray-100 p-4 rounded border hidden">
      <h2 class="font-bold text-lg mb-2">Action History</h2>
      <ul id="historyLog" class="text-sm text-gray-700 list-disc list-inside"></ul>
    </div>
  </div>

  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <h3 class="text-lg font-bold mb-2" id="modalTitle"></h3>
      <ul class="text-sm text-gray-700 list-disc pl-5" id="modalContent"></ul>
      <div class="text-right mt-4">
        <button onclick="closeModal()" class="bg-red-500 text-white px-4 py-2 rounded">Close</button>
      </div>
    </div>
  </div>

  <script>
    // GitHub configuration
    const repoOwner = "cybarra209";
    const repoName = "IT-Equipment-Tracker";
    const branch = "main";
    const filePath = "data.json";
    const githubApiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;
    const githubToken = "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";
    let assets = JSON.parse(localStorage.getItem('assets') || '[]'); // Fallback to localStorage
    let history = JSON.parse(localStorage.getItem('history') || '[]');

    // Fetch data from GitHub
    async function loadData() {
      try {
        console.log("Fetching data from GitHub...");
        const response = await fetch(`${githubApiUrl}?ref=${branch}`, {
          headers: {
            "Accept": "application/vnd.github.v3+json",
          },
        });
        if (!response.ok) {
          const error = await response.json();
          throw new Error(`Failed to fetch data: ${response.status} ${error.message}`);
        }
        const data = await response.json();
        console.log("GitHub response:", data);
        const content = JSON.parse(atob(data.content));
        if (JSON.stringify(content.assets) !== JSON.stringify(assets) ||
            JSON.stringify(content.history) !== JSON.stringify(history)) {
          assets = content.assets || [];
          history = content.history || [];
          localStorage.setItem('assets', JSON.stringify(assets)); // Cache locally
          localStorage.setItem('history', JSON.stringify(history));
          renderTable();
          renderHistory();
        }
        console.log("Data loaded successfully:", assets, history);
        return data.sha;
      } catch (error) {
        console.error("Error loading data:", error.message);
        showModal("Error", `<li>Failed to load data from GitHub: ${error.message}. Using cached data.</li>`);
        renderTable(); // Render cached data
        renderHistory();
      }
    }

    // Save data to GitHub with retry logic
    async function saveData(newAssets, newHistory, message, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          console.log(`Saving data (attempt ${i + 1})...`);
          const sha = await loadData();
          if (!sha) throw new Error("No SHA returned");
          const content = btoa(JSON.stringify({ assets: newAssets, history: newHistory }));
          const response = await fetch(githubApiUrl, {
            method: "PUT",
            headers: {
              "Accept": "application/vnd.github.v3+json",
              "Authorization": `Bearer ${githubToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message || "Update data.json",
              content: content,
              sha: sha,
              branch: branch,
            }),
          });
          if (!response.ok) {
            const error = await response.json();
            throw new Error(`Failed to save data: ${response.status} ${error.message}`);
          }
          console.log("Data saved successfully");
          localStorage.setItem('assets', JSON.stringify(newAssets));
          localStorage.setItem('history', JSON.stringify(newHistory));
          await loadData();
          return;
        } catch (error) {
          console.error(`Save attempt ${i + 1} failed:`, error.message);
          if (i === retries - 1) {
            showModal("Error", `<li>Failed to save data to GitHub after ${retries} attempts: ${error.message}. Changes saved locally.</li>`);
            localStorage.setItem('assets', JSON.stringify(newAssets));
            localStorage.setItem('history', JSON.stringify(newHistory));
            renderTable();
            renderHistory();
          }
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }

    // Form submission
    document.getElementById('assetForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const index = parseInt(document.getElementById('editIndex').value);
      const newAsset = {
        employeeName: document.getElementById('employeeName').value.trim(),
        location: document.getElementById('location').value.trim(),
        itemType: document.getElementById('itemType').value.trim(),
        assetNumber: document.getElementById('assetNumber').value.trim(),
        serialNumber: document.getElementById('serialNumber').value.trim(),
        itemName: document.getElementById('itemName').value.trim(),
      };

      if (!newAsset.employeeName || !newAsset.assetNumber || !newAsset.itemName) {
        showModal('Validation Error', '<li>Please fill in all required fields.</li>');
        return;
      }

      const updatedAssets = [...assets];
      const updatedHistory = [...history];
      if (index >= 0) {
        updatedAssets[index] = newAsset;
        updatedHistory.unshift(`Edited asset #${newAsset.assetNumber} (${newAsset.itemName}) on ${new Date().toLocaleString()}`);
      } else {
        updatedAssets.push(newAsset);
        updatedHistory.unshift(`Added asset #${newAsset.assetNumber} (${newAsset.itemName}) on ${new Date().toLocaleString()}`);
      }

      await saveData(updatedAssets, updatedHistory, `Update asset #${newAsset.assetNumber}`);
      document.getElementById('assetForm').reset();
      document.getElementById('editIndex').value = -1;
    });

    // Edit asset
    function editAsset(index) {
      const asset = assets[index];
      document.getElementById('employeeName').value = asset.employeeName;
      document.getElementById('location').value = asset.location;
      document.getElementById('itemType').value = asset.itemType;
      document.getElementById('assetNumber').value = asset.assetNumber;
      document.getElementById('serialNumber').value = asset.serialNumber;
      document.getElementById('itemName').value = asset.itemName;
      document.getElementById('editIndex').value = index;
    }

    // Delete asset
    async function deleteAsset(index) {
      const asset = assets[index];
      if (!confirm(`Are you sure you want to delete asset #${asset.assetNumber}?`)) return;
      const updatedAssets = assets.filter((_, i) => i !== index);
      const updatedHistory = [...history, `Deleted asset #${asset.assetNumber} (${asset.itemName}) on ${new Date().toLocaleString()}`];
      await saveData(updatedAssets, updatedHistory, `Delete asset #${asset.assetNumber}`);
    }

    // Delete history entry
    async function deleteHistory(index) {
      if (!confirm("Delete this history entry?")) return;
      const updatedHistory = history.filter((_, i) => i !== index);
      await saveData(assets, updatedHistory, "Delete history entry");
    }

    // View history for an asset
    function viewHistory(assetNumber, itemType) {
      const logs = history.filter(entry => entry.includes(`#${assetNumber}`));
      const title = `History for ${itemType} (Asset ${assetNumber})`;
      document.getElementById('modalTitle').innerText = title;
      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = logs.length ? logs.map(l => `<li>${l}</li>`).join('') : '<li>No history available.</li>';
      document.getElementById('modal').classList.remove('hidden');
    }

    // Polling for real-time updates
    setInterval(() => {
      console.log("Polling for updates...");
      loadData();
    }, 10000);

    // Initialize data
    loadData();

    // Render table
    function renderTable(filter = '') {
      const container = document.getElementById('assetTableContainer');
      if (assets.length === 0) {
        container.innerHTML = '<p class="text-gray-500">No assets recorded.</p>';
        return;
      }

      let html = `
        <table class="min-w-full text-sm border">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2 border">Employee Name</th>
              <th class="p-2 border">Location</th>
              <th class="p-2 border">Item Type</th>
              <th class="p-2 border">Asset #</th>
              <th class="p-2 border">Serial #</th>
              <th class="p-2 border">Item Name</th>
              <th class="p-2 border">Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      assets.filter(asset => {
        const text = Object.values(asset).join(' ').toLowerCase();
        return text.includes(filter.toLowerCase());
      }).forEach((asset, index) => {
        html += `
          <tr class="border-b">
            <td class="p-2 border">${asset.employeeName}</td>
            <td class="p-2 border">${asset.location}</td>
            <td class="p-2 border">${asset.itemType}</td>
            <td class="p-2 border">${asset.assetNumber}</td>
            <td class="p-2 border">${asset.serialNumber}</td>
            <td class="p-2 border">${asset.itemName}</td>
            <td class="p-2 border space-x-1">
              <button class="text-blue-500 underline" onclick="viewHistory('${asset.assetNumber}', '${asset.itemType}')">History</button>
              <button class="text-yellow-500 underline" onclick="editAsset(${index})">Edit</button>
              <button class="text-red-500 underline" onclick="deleteAsset(${index})">Delete</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Render history
    function renderHistory() {
      const historyLog = document.getElementById('historyLog');
      historyLog.innerHTML = history.map((entry, i) => `<li>${entry} <button onclick="deleteHistory(${i})" class="text-red-500 ml-2">🗑</button></li>`).join('');
    }

    // Toggle history section
    function toggleHistory() {
      document.getElementById('historySection').classList.toggle('hidden');
    }

    // Close modal
    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
    }

    // Print history
    function printModalHistory() {
      const printWindow = window.open('', '', 'width=800,height=600');
      const title = document.getElementById('modalTitle').innerText;
      const items = Array.from(document.getElementById('modalContent').children).map(li => `<li>${li.innerText}</li>`).join('');
      printWindow.document.write(`
        <html><head><title>Print History</title></head><body>
        <h3>${title}</h3><ul>${items}</ul>
        </body></html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    // Download assets as CSV
    function downloadAssets() {
      if (!assets.length) {
        alert("No assets to download.");
        return;
      }
      const headers = ["employeeName", "location", "itemType", "assetNumber", "serialNumber", "itemName"];
      const csvRows = [headers.join(',')];
      for (const asset of assets) {
        const row = headers.map(header => (asset[header] || '').replace(/"/g, '""')).join(',');
        csvRows.push(row);
      }
      const csvData = csvRows.join('\n');
      const blob = new Blob([csvData], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'assets.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Import CSV
    async function importCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async function (e) {
        const text = e.target.result;
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',');

        const updatedAssets = [...assets];
        const updatedHistory = [...history];
        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',');
          const asset = {};
          headers.forEach((header, index) => {
            asset[header.trim()] = values[index]?.trim().replace(/^"|"$/g, '') || '';
          });
          if (asset.assetNumber && asset.itemName) {
            updatedAssets.push(asset);
            updatedHistory.unshift(`Imported asset #${asset.assetNumber} (${asset.itemName}) on ${new Date().toLocaleString()}`);
          }
        }
        await saveData(updatedAssets, updatedHistory, "Import CSV data");
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
